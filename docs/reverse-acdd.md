# Reverse ACDD

For projects **without existing specifications**, fspec provides **Reverse ACDD** via the `/rspec` command in Claude Code.

## What is Reverse ACDD?

Reverse ACDD reverse engineers existing codebases to discover user stories, personas, and acceptance criteria, then creates fspec artifacts (work units, epics, feature files, test skeletons).

**Use cases:**
- Legacy codebases without specifications
- Projects transitioning to ACDD workflow
- Understanding inherited code through BDD lens

## Installing /rspec Command

```bash
# Initialize fspec (installs /fspec and /rspec commands)
fspec init
```

This creates:
- `.claude/commands/fspec.md` - Forward ACDD command
- `.claude/commands/rspec.md` - Reverse ACDD command (reads fspec.md first)
- `spec/CLAUDE.md` - Specification management guidelines

## Reverse ACDD Workflow

When you run `/rspec` in Claude Code, the AI will:

### 1. Analyze Codebase

Identify user-facing interactions:
- **Web apps:** Routes, API endpoints, UI components
- **CLI apps:** Commands, subcommands, flags
- **Desktop/Mobile:** Screens, actions, gestures
- **Services:** Scheduled jobs, event processors

### 2. Group into Epics

Organize by business domain:
```bash
fspec create-epic user-management "User Management Features" AUTH
fspec create-epic payment-processing "Payment Processing" PAY
```

### 3. Create Work Units

One per user story:
```bash
fspec create-work-unit AUTH "User Login" --epic=user-management
fspec update-work-unit-status AUTH-001 specifying
```

### 4. Generate Feature Files

Infer acceptance criteria from code:
- **Routes** → scenarios (e.g., POST /login → "Login with valid credentials")
- **Error handling** → edge cases (e.g., 401 error → "Login with invalid credentials")
- **Validation** → preconditions (e.g., email.includes('@') → valid email format)
- **Business logic** → rules (e.g., age >= 18 → user must be adult)

### 5. Create Test Skeletons

Structure only (NOT implemented):
```typescript
/**
 * Feature: spec/features/user-login.feature
 *
 * NOTE: This is a skeleton test file generated by reverse ACDD.
 * Tests are NOT implemented - only structure is provided.
 */
describe('Feature: User Login', () => {
  describe('Scenario: Login with valid credentials', () => {
    it('should redirect to dashboard', async () => {
      // TODO: Implement this test
    });
  });
});
```

### 6. Update Foundation

Add user story maps:
```bash
fspec add-diagram "User Story Maps" "Auth Flow" "
graph TB
  User[User] -->|Login| AUTH-001[User Login]
  AUTH-001 -->|Success| DASH-001[View Dashboard]
"
```

## Handling Ambiguous Code

When encountering unclear business logic, the AI will:

1. Document what's clear from the code
2. Mark scenarios as "AMBIGUOUS" with comments
3. Offer Example Mapping to clarify with human

```gherkin
# AMBIGUOUS: magic number 42 in discount logic - needs human clarification
Scenario: Apply special discount
  Given a customer has a discount code
  And the discount value is greater than 42  # Why 42? Ask human.
  When they complete checkout
  Then a special discount should be applied
```

## Coverage Tracking for Reverse ACDD

Link existing code to scenarios:

```bash
# 1. Create feature and scenarios
fspec create-feature "User Login"
fspec add-scenario user-login "Login with valid credentials"

# 2. Create skeleton test file (src/__tests__/auth-login.test.ts:13-27)

# 3. Link skeleton test (use --skip-validation for unimplemented tests)
fspec link-coverage user-login --scenario "Login with valid credentials" \
  --test-file src/__tests__/auth-login.test.ts --test-lines 13-27 \
  --skip-validation

# 4. Link existing implementation
fspec link-coverage user-login --scenario "Login with valid credentials" \
  --test-file src/__tests__/auth-login.test.ts \
  --impl-file src/routes/auth.ts --impl-lines 45-67 \
  --skip-validation

# 5. Check coverage gaps
fspec show-coverage
```

See [Coverage Tracking Guide](./coverage-tracking.md) for complete details.

## Completion Criteria

Reverse ACDD is complete when:
- ✅ All user-facing interactions have feature files
- ✅ All epics have at least one work unit
- ✅ foundation.json contains user story map(s)
- ✅ All ambiguous scenarios documented
- ✅ Skeleton test files exist

## Transitioning to Forward ACDD

After reverse ACDD, use forward ACDD for new features:
- Discovery (Example Mapping) → Specify → Test → Implement → Validate

## Next Steps

- [Getting Started](./getting-started.md) - Learn forward ACDD workflow
- [Coverage Tracking](./coverage-tracking.md) - Maintain traceability
- [Project Management](./project-management.md) - Kanban workflow
