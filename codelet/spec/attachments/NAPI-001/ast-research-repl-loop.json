{
  "matches": [
    {
      "type": "function_item",
      "name": "repl_loop",
      "line": 14,
      "column": 0,
      "text": "pub(super) async fn repl_loop(session: &mut Session) -> Result<()> {\n    let mut input_queue = InputQueue::new();\n    let is_interrupted = Arc::new(AtomicBool::new(false));\n\n    println!(\"Enter your prompt (or 'exit' to quit):\");\n\n    loop {\n        // Read user input with provider-prefixed prompt\n        print!(\"{}\", session.provider_manager().get_prompt_prefix());\n        std::io::stdout().flush()?;\n\n        let mut input = String::new();\n        std::io::stdin().read_line(&mut input)?;\n        let input = input.trim();\n\n        // Check for exit\n        if matches!(input, \"exit\" | \"/quit\" | \"quit\") {\n            println!(\"Goodbye!\");\n            break;\n        }\n\n        // Handle /debug command - CLI-022\n        if input == \"/debug\" {\n            let result = handle_debug_command();\n            // Set session metadata when enabling debug capture\n            if result.enabled {\n                if let Ok(manager_arc) = get_debug_capture_manager() {\n                    if let Ok(mut manager) = manager_arc.lock() {\n                        manager.set_session_metadata(SessionMetadata {\n                            provider: Some(session.current_provider_name().to_string()),\n                            model: Some(session.current_provider_name().to_string()),\n                            context_window: Some(session.provider_manager().context_window()),\n                            max_output_tokens: None,\n                        });\n                    }\n                }\n            }\n            // CLI-022: Capture command.executed event\n            if let Ok(manager_arc) = get_debug_capture_manager() {\n                if let Ok(mut manager) = manager_arc.lock() {\n                    if manager.is_enabled() {\n                        manager.capture(\n                            \"command.executed\",\n                            serde_json::json!({\n                                \"command\": \"/debug\",\n                                \"result\": if result.enabled { \"enabled\" } else { \"disabled\" },\n                            }),\n                            None,\n                        );\n                    }\n                }\n            }\n            println!(\"{}\\n\", result.message);\n            continue;\n        }\n\n        // Check for provider switch - CLEARS CONTEXT (CLI-008)\n        if input.starts_with('/') {\n            let provider = input.trim_start_matches('/');\n            // Capture provider.switch event - CLI-022\n            if let Ok(manager_arc) = get_debug_capture_manager() {\n                if let Ok(mut manager) = manager_arc.lock() {\n                    if manager.is_enabled() {\n                        manager.capture(\n                            \"provider.switch\",\n                            serde_json::json!({\n                                \"from\": session.current_provider_name(),\n                                \"to\": provider,\n                            }),\n                            None,\n                        );\n                    }\n                }\n            }\n            match session.switch_provider(provider) {\n                Ok(()) => {\n                    info!(\"Provider switched to: {}\", provider);\n                    println!(\"Switched to {provider} provider\\n\");\n                    continue;\n                }\n                Err(e) => {\n                    debug!(\"Provider switch failed: {}\", e);\n                    eprintln!(\"Error switching provider: {e}\\n\");\n                    continue;\n                }\n            }\n        }\n\n        if input.is_empty() {\n            continue;\n        }\n\n        // Capture user.input event - CLI-022\n        if let Ok(manager_arc) = get_debug_capture_manager() {\n            if let Ok(mut manager) = manager_arc.lock() {\n                if manager.is_enabled() {\n                    manager.capture(\n                        \"user.input\",\n                        serde_json::json!({\n                            \"input\": input,\n                            \"inputLength\": input.len(),\n                        }),\n                        None,\n                    );\n                    // Increment turn for each user input\n                    manager.increment_turn();\n                }\n            }\n        }\n\n        // Run agent with interruption support and persistent context (CLI-008)\n        // Enable raw mode only during agent execution for ESC key detection\n        is_interrupted.store(false, Ordering::Relaxed);\n        enable_raw_mode()?;\n        let mut event_stream = create_event_stream();\n\n        let agent_result = run_agent_with_interruption(\n            session,\n            input,\n            &mut event_stream,\n            &mut input_queue,\n            is_interrupted.clone(),\n        )\n        .await;\n\n        // Always disable raw mode after agent completes\n        disable_raw_mode()?;\n\n        match agent_result {\n            Ok(()) => println!(\"\\n\"),\n            Err(e) => eprintln!(\"Error: {e}\\n\"),\n        }\n    }\n\n    Ok(())\n}"
    }
  ]
}
