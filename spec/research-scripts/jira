#!/usr/bin/env node

/**
 * JIRA Research Tool
 * Integrates with fspec research framework (RES-002)
 */

import fs from 'fs';
import path from 'path';
import os from 'os';
import https from 'https';

// Parse command-line arguments
function parseArgs() {
  const args = process.argv.slice(2);
  const parsed = {
    issue: null,
    project: null,
    query: null,
    format: 'markdown',
    help: false,
  };

  for (let i = 0; i < args.length; i++) {
    if (args[i] === '--help') {
      parsed.help = true;
    } else if (args[i] === '--issue' && args[i + 1]) {
      parsed.issue = args[i + 1];
      i++;
    } else if (args[i] === '--project' && args[i + 1]) {
      parsed.project = args[i + 1];
      i++;
    } else if (args[i] === '--query' && args[i + 1]) {
      parsed.query = args[i + 1];
      i++;
    } else if (args[i] === '--format' && args[i + 1]) {
      parsed.format = args[i + 1];
      i++;
    }
  }

  return parsed;
}

// Show help text
function showHelp() {
  console.log(`JIRA RESEARCH TOOL

Research JIRA issues during Example Mapping.

USAGE
  jira --issue <key> [options]
  jira --project <key> [options]
  jira --query <jql> [options]

OPTIONS
  --issue <key>       Fetch single issue by key (required if no --project or --query)
  --project <key>     List all issues in project (required if no --issue or --query)
  --query <jql>       JQL query to search issues (required if no --issue or --project)
  --format <type>     Output format: markdown, json, text (default: markdown)
  --help              Show this help message

JQL EXAMPLES
  jira --query "project = AUTH AND status = Open"
  jira --query "assignee = currentUser() AND status != Done"
  jira --query "labels = security AND priority = High"

CONFIGURATION
  API credentials must be set in ~/.fspec/fspec-config.json:
  {
    "research": {
      "jira": {
        "jiraUrl": "https://example.atlassian.net",
        "username": "your-email@example.com",
        "apiToken": "your-api-token"
      }
    }
  }

EXIT CODES
  0  Success
  1  Missing required flag (--issue, --project, or --query)
  2  Configuration or authentication error
  3  API error (network, not found, etc.)`);
}

// Load config from ~/.fspec/fspec-config.json
function loadConfig() {
  const configPath = path.join(os.homedir(), '.fspec', 'fspec-config.json');

  if (!fs.existsSync(configPath)) {
    console.error('Error: Config file not found at ~/.fspec/fspec-config.json');
    console.error('Create config with JIRA credentials:');
    console.error('  mkdir -p ~/.fspec');
    console.error('  echo \'{"research":{"jira":{"jiraUrl":"https://example.atlassian.net","username":"your-email","apiToken":"your-token"}}}\' > ~/.fspec/fspec-config.json');
    process.exit(2);
  }

  const config = JSON.parse(fs.readFileSync(configPath, 'utf8'));

  if (!config.research?.jira?.jiraUrl || !config.research?.jira?.username || !config.research?.jira?.apiToken) {
    console.error('Error: JIRA configuration not found');
    console.error('Add to ~/.fspec/fspec-config.json:');
    console.error('  "research": { "jira": { "jiraUrl": "...", "username": "...", "apiToken": "..." } }');
    console.error('');
    console.error('Required config fields: jiraUrl, username, apiToken');
    process.exit(2);
  }

  return config.research.jira;
}

// Call JIRA API
function callJiraAPI(config, path) {
  return new Promise((resolve, reject) => {
    const urlObj = new URL(config.jiraUrl);
    const auth = Buffer.from(`${config.username}:${config.apiToken}`).toString('base64');

    const options = {
      hostname: urlObj.hostname,
      port: 443,
      path: path,
      method: 'GET',
      headers: {
        'Authorization': `Basic ${auth}`,
        'Accept': 'application/json',
      },
    };

    const req = https.request(options, (res) => {
      let data = '';

      res.on('data', (chunk) => {
        data += chunk;
      });

      res.on('end', () => {
        if (res.statusCode === 401) {
          console.error(`Error: JIRA API authentication failed (HTTP 401)`);
          console.error(`Reason: Unauthorized - Invalid credentials`);
          process.exit(2);
        } else if (res.statusCode === 404) {
          console.error(`Error: JIRA API request failed (HTTP 404)`);
          console.error(`Reason: Issue not found`);
          process.exit(3);
        } else if (res.statusCode !== 200) {
          const error = JSON.parse(data);
          console.error(`Error: JIRA API request failed (HTTP ${res.statusCode})`);
          console.error(`Reason: ${error.errorMessages?.[0] || 'Unknown error'}`);
          process.exit(3);
        }
        resolve(JSON.parse(data));
      });
    });

    req.on('error', (err) => {
      console.error(`Error: Network request failed`);
      console.error(`Reason: ${err.message}`);
      process.exit(3);
    });

    req.end();
  });
}

// Format single issue as markdown
function formatIssueMarkdown(issue) {
  const timestamp = new Date().toISOString();

  return `# Issue: ${issue.key}

**Summary:** ${issue.fields.summary}
**Status:** ${issue.fields.status.name}
**Assignee:** ${issue.fields.assignee?.displayName || 'Unassigned'}
**Labels:** ${issue.fields.labels.join(', ') || 'None'}
**Date:** ${timestamp}

---

## Description

${issue.fields.description || 'No description provided'}

---

**URL:** ${issue.self}`;
}

// Format issue list as markdown
function formatIssuesMarkdown(issues, query) {
  const timestamp = new Date().toISOString();

  let output = `# JIRA Search Results\n\n**Query:** ${query}\n**Date:** ${timestamp}\n**Results:** ${issues.length}\n\n---\n\n`;

  for (const issue of issues) {
    output += `## ${issue.key}: ${issue.fields.summary}\n\n`;
    output += `**Status:** ${issue.fields.status.name}\n`;
    output += `**Assignee:** ${issue.fields.assignee?.displayName || 'Unassigned'}\n`;
    output += `**URL:** ${issue.self}\n\n`;
  }

  return output;
}

// Format as JSON
function formatJSON(data) {
  if (Array.isArray(data)) {
    return JSON.stringify(
      data.map((issue) => ({
        key: issue.key,
        summary: issue.fields.summary,
        status: issue.fields.status.name,
        assignee: issue.fields.assignee?.displayName || 'Unassigned',
        url: issue.self,
      })),
      null,
      2
    );
  } else {
    return JSON.stringify(
      {
        key: data.key,
        summary: data.fields.summary,
        status: data.fields.status.name,
        assignee: data.fields.assignee?.displayName || 'Unassigned',
        labels: data.fields.labels,
        description: data.fields.description,
        url: data.self,
      },
      null,
      2
    );
  }
}

// Format as plain text
function formatText(data) {
  if (Array.isArray(data)) {
    return data.map((issue) => `${issue.key}: ${issue.fields.summary}`).join('\n');
  } else {
    return `${data.key}: ${data.fields.summary}\n\n${data.fields.description || 'No description'}`;
  }
}

// Main function
async function main() {
  const args = parseArgs();

  // Show help
  if (args.help) {
    showHelp();
    process.exit(0);
  }

  // Validate required args
  if (!args.issue && !args.project && !args.query) {
    console.error('Error: At least one of --query, --issue, or --project is required');
    process.exit(1);
  }

  // Test mode: return mock data
  if (process.env.FSPEC_TEST_MODE === '1') {
    let mockData;
    let query = '';

    if (args.issue) {
      query = `Issue ${args.issue}`;
      mockData = {
        key: args.issue,
        fields: {
          summary: 'Mock JIRA issue summary',
          description: 'This is test mode output. In production, this would contain real issue data from JIRA.',
          status: { name: 'In Progress' },
          assignee: { displayName: 'Test User' },
          labels: ['test', 'mock'],
        },
      };
    } else if (args.project) {
      query = `Project ${args.project}`;
      mockData = [
        {
          key: `${args.project}-1`,
          fields: {
            summary: 'Mock issue 1',
            status: { name: 'Open' },
          },
        },
        {
          key: `${args.project}-2`,
          fields: {
            summary: 'Mock issue 2',
            status: { name: 'In Progress' },
          },
        },
      ];
    } else if (args.query) {
      query = args.query;
      mockData = [
        {
          key: 'MOCK-1',
          fields: {
            summary: 'Mock JIRA search result',
            status: { name: 'Open' },
          },
        },
      ];
    }

    let output;
    if (args.format === 'json') {
      output = formatJSON(mockData);
    } else if (args.format === 'text') {
      output = formatText(mockData);
    } else {
      if (Array.isArray(mockData)) {
        output = formatIssuesMarkdown(mockData, query);
      } else {
        output = formatIssueMarkdown(mockData);
      }
    }

    console.log(output);
    process.exit(0);
  }

  // Load config
  const config = loadConfig();

  // Fetch data from JIRA
  let data;
  let query = '';

  if (args.issue) {
    // Fetch single issue
    query = `Issue ${args.issue}`;
    data = await callJiraAPI(config, `/rest/api/2/issue/${args.issue}`);
  } else if (args.project) {
    // Fetch project issues
    query = `Project ${args.project}`;
    const result = await callJiraAPI(
      config,
      `/rest/api/2/search?jql=project=${args.project}`
    );
    data = result.issues;
  } else if (args.query) {
    // JQL query
    query = args.query;
    const result = await callJiraAPI(
      config,
      `/rest/api/2/search?jql=${encodeURIComponent(args.query)}`
    );
    data = result.issues;
  }

  // Format and output
  let output;
  if (args.format === 'json') {
    output = formatJSON(data);
  } else if (args.format === 'text') {
    output = formatText(data);
  } else {
    if (Array.isArray(data)) {
      output = formatIssuesMarkdown(data, query);
    } else {
      output = formatIssueMarkdown(data);
    }
  }

  console.log(output);
  process.exit(0);
}

main().catch((err) => {
  console.error('Error:', err.message);
  process.exit(3);
});
