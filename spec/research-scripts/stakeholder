#!/usr/bin/env node

/**
 * Stakeholder Communication Research Tool
 * Integrates with fspec research framework (RES-006)
 * Sends questions to stakeholders via chat platforms (Teams, Slack, etc.)
 */

import fs from 'fs';
import path from 'path';
import os from 'os';

// Parse command-line arguments
function parseArgs() {
  const args = process.argv.slice(2);
  const parsed = {
    platform: null,
    question: null,
    workUnit: null,
    help: false,
  };

  for (let i = 0; i < args.length; i++) {
    if (args[i] === '--help') {
      parsed.help = true;
    } else if (args[i] === '--platform' && args[i + 1]) {
      parsed.platform = args[i + 1];
      i++;
    } else if (args[i] === '--question' && args[i + 1]) {
      parsed.question = args[i + 1];
      i++;
    } else if (args[i] === '--work-unit' && args[i + 1]) {
      parsed.workUnit = args[i + 1];
      i++;
    }
  }

  return parsed;
}

// Show help text
function showHelp() {
  console.log(`STAKEHOLDER COMMUNICATION RESEARCH TOOL

Send questions to stakeholders via chat platforms during Example Mapping.

USAGE
  stakeholder --platform <platform> --question <question> [options]

OPTIONS
  --platform <platform>   Platform to send to: teams, slack, discord (required)
                         Multiple platforms: --platform=teams,slack
  --question <question>   Question to send to stakeholders (required)
  --work-unit <id>        Work unit ID for context (optional)
  --help                  Show this help message

EXAMPLES
  stakeholder --platform=teams --question="Should we support OAuth2?"
  stakeholder --platform=slack --question="OAuth support needed?" --work-unit=AUTH-001
  stakeholder --platform=teams,slack --question="test"

PLUGIN ARCHITECTURE
  - Platform plugins stored in spec/research-scripts/plugins/
  - Plugins can be any executable file (shell, Python, Node, compiled binary)
  - Auto-discovered by checking executable bit
  - No file extension required

CONFIGURATION
  Credentials stored in ~/.fspec/fspec-config.json:
  {
    "research": {
      "stakeholder": {
        "teams": { "webhookUrl": "..." },
        "slack": { "token": "...", "channel": "..." }
      }
    }
  }

EXIT CODES
  0  Success
  1  Missing required arguments
  2  Configuration error`);
}

// Generate mock data for test mode
function generateMockData(args) {
  let output = '';

  if (args.workUnit) {
    output += `# Stakeholder Question for ${args.workUnit}\n\n`;
    output += `**Platform:** ${args.platform}\n`;
    output += `**Question:** ${args.question}\n\n`;
    output += `**Work Unit Context:**\n`;
    output += `- ID: ${args.workUnit}\n`;
    output += `- Title: User Login\n`;
    output += `- Epic: user-management\n\n`;
    output += `**Rules:**\n`;
    output += `1. Password must be 8+ chars\n\n`;
    output += `**Examples:**\n`;
    output += `1. Valid login with email/password\n\n`;
    output += `**Previous Q&A:**\n`;
    output += `Q: Support 2FA? A: Yes, in phase 2\n\n`;
  } else {
    output += `# Stakeholder Question\n\n`;
    output += `**Platform:** ${args.platform}\n`;
    output += `**Question:** ${args.question}\n\n`;
  }

  output += `This is test mode output. In production, this message would be sent to:\n`;

  const platforms = args.platform.split(',');
  for (const platform of platforms) {
    output += `- ${platform.trim()}\n`;
  }

  output += `\nMessage sent successfully (test mode).\n`;
  output += `Stakeholders will be notified and can respond manually.\n`;

  return output;
}

// Main function
async function main() {
  const args = parseArgs();

  // Show help
  if (args.help) {
    showHelp();
    process.exit(0);
  }

  // Validate required args
  if (!args.platform || !args.question) {
    console.error('Error: --platform and --question are required');
    console.error('Run "stakeholder --help" for usage information');
    process.exit(1);
  }

  // Test mode: return mock data
  if (process.env.FSPEC_TEST_MODE === '1') {
    const mockData = generateMockData(args);
    console.log(mockData);
    process.exit(0);
  }

  // Production mode would:
  // 1. Load config from ~/.fspec/fspec-config.json
  // 2. Auto-discover platform plugins from spec/research-scripts/plugins/
  // 3. Execute plugin(s) with question and context
  // 4. Exit without waiting for response (fire-and-forget)

  console.error('Error: Production mode not yet implemented');
  console.error('This tool currently only supports FSPEC_TEST_MODE=1 for testing');
  process.exit(2);
}

main().catch((err) => {
  console.error('Error:', err.message);
  process.exit(3);
});
